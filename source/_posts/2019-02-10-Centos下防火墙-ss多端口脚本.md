---
title: Centos下防火墙+ss多端口脚本
date: 2019-02-10 02:40:31
categories:
- Linux
tags:
- Linux
- Note
---
# 目的

开启SS之后，添加多端口再去打开防火墙比较麻烦，做了一个一键脚本。

## 代码

``` bash
#!/bin/sh
method="aes-256-cfb"
mup="6001"
log="./add.log"

echo -e -n "add: {\"server_port\": $1, \"password\":\"$2\"}" > /dev/udp/127.0.0.1/$mup

tcp=$(firewall-cmd --zone=public --add-port=$1/tcp --permanent)
echo "TCP端口 $1 开放操作: $tcp"

udp=$(firewall-cmd --zone=public --add-port=$1/udp --permanent)
echo "udp端口 $1 开放操作: $udp"

rel=$(firewall-cmd --reload)
echo "防火墙重启操作: $rel"

echo "IP:$(curl ipinfo.io/ip) 端口:$1 密码:$2"

if [ ! -f "$log" ]; then

    echo -e -n "\"$1\":\"$2\"" >> add.log

else

    echo -e -n ",\n\"$1\":\"$2\"" >> add.log

fi

# base64链接
link=$( base64 <<< "$method:$2@$(get_ip):$1" )

echo "ss://$link"
```

其中获得IP的函数，依赖curl，需要能够访问两个网站：
'ipinfo.io'
和
'ipv4.icanhazip.com'

``` bash
get_ip(){
  IP = $(curl ipinfo.io/ip)
  echo ${IP}
}
```

或

``` bash
get_ip(){
  IP = $(curl ipv4.icanhazip.com)
  echo ${IP}
}
```

通过查看本地网络连接信息的方式也可，用正则表达式筛选

``` bash
get_ip(){
    local IP=$( ip addr | egrep -o '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | egrep -v "^192\.168|^172\.1[6-9]\.|^172\.2[0-9]\.|^172\.3[0-2]\.|^10\.|^127\.|^255\.|^0\." | head -n 1 )
    echo ${IP}
}
```